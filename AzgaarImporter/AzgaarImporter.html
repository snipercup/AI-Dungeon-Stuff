<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Azgaar importer for AID</title>
  </head>
  <body>
    <p>Import Azgaar data to AID</p>
    
    <TABLE border=1>
      <TR>
        <TD colspan=2>Cell geojson data</TD><TD>Burgs csv data</TD><TD rowspan=10 id="statesCheckBoxes">Enter<BR>the<BR>data</TD>
      </TR>
      <TR>
        <TD colspan=2><textarea id="cellData" name="cellData" rows="4" cols="54"></textarea></TD>
        <TD><textarea id="burgData" name="burgData" rows="4" cols="50"></textarea></TD>
      </TR>
      <TR>
        <TD colspan=2>States csv data</TD><TD>Provinces csv data</TD>
      </TR>
      <TR>
        <TD colspan=2><textarea id="statesData" name="statesData" rows="4" cols="54"></textarea></TD>
        <TD><textarea id="provincesData" name="provincesData" rows="4" cols="50"></textarea></TD>
      </TR>
      <TR>
        <TD>Biome csv data</TD><TD>Culture csv data</TD><TD>Religion csv data</TD>
      </TR>
      <TR>
        <TD><textarea id="biomeData" name="biomeData" rows="4" cols="25"></textarea></TD>
        <TD><textarea id="cultureData" name="cultureData" rows="4" cols="25"></textarea></TD>
        <TD><textarea id="religionData" name="religionData" rows="4" cols="50"></textarea></TD>
      </TR>
      <TR>
        <TD colspan=2>Controls</TD><TD>Debug Output</TD>
      </TR>
      <TR>
        <TD colspan=2 rowspan=3>
          <button type="button" onclick="processdata()">Process data</button><BR>
          <button type="button" onclick="selectCells()">Convert cells</button>
        </TD>
        <TD><textarea id="outputData" name="outputData" rows="10" cols="50"></textarea></TD>
      </TR>
      <TR>
        <TD>JSON Output</TD>
      </TR>
      <TR>
        <TD><textarea id="outputJSONData" name="outputJSONData" rows="5" cols="50"></textarea></TD>
      </TR>
  </body>
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
  
  <script type="text/javascript">
    //The user has entered all the required data and pressed the 'process data' button.
    //It will create a list of checkboxes for the states
    function processdata() {
      let obj1 = JSON.parse(document.getElementById("cellData").value);
      let outputDataString = "";
      let islandTypes = obj1.features.filter(island => island.properties.type == 'island');
      outputDataString += "islandTypes.length = " + islandTypes.length + "\n";

      //Transform the csv data for states into JSON
      let csv = document.getElementById("statesData").value
      // Key data by field name instead of index/position
      var results = Papa.parse(csv, {
        header: true, skipEmptyLines: true
      });

      //Use the JSON data to create a list of checkboxes for the states
      let statesDataArray = results.data
      outputDataString += "results.length = " + statesDataArray.length + "\n"; 
      let i, stateVar;
      let statesCheckHTML = "<div>"
      for (i = 0; i < statesDataArray.length; i++) {
        stateVar = statesDataArray[i]
        if(stateVar["State"]){
          statesCheckHTML += "<input type='checkbox' checked id='statebox" + stateVar["State"] + "'/> ";
          statesCheckHTML += "<label>" + stateVar["State"] + "</label><BR>"
        }
      }
      statesCheckHTML += "</div>"
      
      //Update the HTML
      let statesCheckBoxesElement = document.getElementById("statesCheckBoxes")
      statesCheckBoxesElement.innerHTML = statesCheckHTML;
      document.getElementById("outputData").value = outputDataString;
      return;
    }
    
    //Select all cells that have their state selected
    function selectCells() {

      let jsonData = document.getElementById("cellData").value
      let obj1 = JSON.parse(jsonData);
      let cellFeatures = obj1.features;
      let islandTypes = cellFeatures.filter(island => island.properties.type == 'island');
      let stateSelectedCells = [];
      let stateInt = 0;
      let cellFilteredStateData;
      //let islandTypes = obj1.features.filter(island => island.properties.type == 'island');
      let csv;
      
      csv = document.getElementById("statesData").value
      if(csv == ""){
        alert("Missing states data. Please add it.");
        return;
      };
      // Key data by field name instead of index/position
      var statesDataJSON = Papa.parse(csv, {
        header: true, skipEmptyLines: true
      });
      let statesDataArray = statesDataJSON.data
      
      csv = document.getElementById("provincesData").value
      if(csv == ""){
        alert("Missing provinces data. Please add it.");
        return;
      };
      // Key data by field name instead of index/position
      var provincesDataJSON = Papa.parse(csv, {
        header: true, skipEmptyLines: true
      });
      let provinceDataArray = provincesDataJSON.data
      
      csv = document.getElementById("cultureData").value
      if(csv == ""){
        alert("Missing culture data. Please add it.");
        return;
      };
      // Key data by field name instead of index/position
      var cultureDataJSON = Papa.parse(csv, {
        header: true, skipEmptyLines: true
      });
      let cultureDataArray = cultureDataJSON.data
      
      csv = document.getElementById("religionData").value
      if(csv == ""){
        alert("Missing religion data. Please add it.");
        return;
      };
      // Key data by field name instead of index/position
      var religionDataJSON = Papa.parse(csv, {
        header: true, skipEmptyLines: true
      });
      let religionDataArray = religionDataJSON.data
      
      csv = document.getElementById("biomeData").value
      if(csv == ""){
        alert("Missing biome data. Please add it.");
        return;
      };
      // Key data by field name instead of index/position
      var biomeDataJSON = Papa.parse(csv, {
        header: true, skipEmptyLines: true
      });
      let biomeDataArray = biomeDataJSON.data
      
      csv = document.getElementById("burgData").value
      if(csv == ""){
        alert("Missing burg data. Please add it.");
        return;
      };
      // Key data by field name instead of index/position
      var burgDataJSON = Papa.parse(csv, {
        header: true, skipEmptyLines: true
      });
      let burgDataArray = burgDataJSON.data

      //The total amount of cells is reduced to only the cells of which their state is selected in the checkboxes
      let i, stateVar;
      let stateCells = []; //Contains cells that have their state selected in the checkboxes
      for (i = 0; i < statesDataArray.length; i++) {
        stateVar = statesDataArray[i]
        if(stateVar["Id"]){
          if(document.getElementById("statebox" + stateVar["State"]).checked){
            stateInt = parseInt(stateVar["Id"]);
            stateSelectedCells = islandTypes.filter(state => state.properties.state == stateInt);
            stateCells = stateCells.concat(stateSelectedCells); 
          }
        }
      }
      
      document.getElementById("outputData").value += "\nstateCells.length = " + stateCells.length;
      
      //Set up the common properties of the entries
      let jsonEntry = {}, jsonEntryList = [];
      jsonEntry.type = "worldDescription"
      jsonEntry.keys = ""
      jsonEntry.entry = ""
      jsonEntry.hidden = false;
      jsonEntry.generator = "Manual"
      jsonEntry.name = null
      jsonEntry.description = null
      jsonEntry.attributes = { "name": null, "description": null }
      
      let itemProvinceText, itemStateText, itemReligionText, itemCultureText, itemBiomeText, itemPopulationText;
      let burgLatitude, burgLongtitude, cellCoordinates, cellLatitude, cellLongtitude, burgFound, foundBurg;
      let filteredBurgData = [], cellStateName;
      var keys = [];
      
      let selectedCell, selectedProperties;
      for (i = 0; i < stateCells.length; i++) {
        selectedCell = stateCells[i];
        selectedProperties = selectedCell.properties;
        
        cellCoordinates = selectedCell.geometry.coordinates[0];
        itemProvinceText = numberToName(provinceDataArray, selectedProperties.province, "Province");
        itemStateText = numberToName(statesDataArray, selectedProperties.state, "State");
        itemReligionText = numberToName(religionDataArray, selectedProperties.religion, "Religion");
        itemCultureText = numberToName(cultureDataArray, selectedProperties.culture, "Culture");
        itemBiomeText = numberToName(biomeDataArray, selectedProperties.biome, "Biome");
        itemPopulationText = selectedProperties.population;
        itemElevationText = selectedProperties.height;

        filteredBurgData = burgDataArray.filter(burg => burg.State.indexOf(itemStateText) > -1);
        cellStateName = filteredBurgData[0].State; //Gets the actual name of the state
        filteredBurgData = filteredBurgData.filter(burg => burg.Province.indexOf(itemProvinceText) > -1);
        filteredBurgData = filteredBurgData.filter(burg => burg.Culture == itemCultureText);
        filteredBurgData = filteredBurgData.filter(burg => burg.Religion == itemReligionText);
        
        foundBurg = null;
        let elevation = 0;
        for (y = 0; y < filteredBurgData.length; y++) {
          foundBurg = filteredBurgData[y];
          elevation = foundBurg["Elevation (ft)"];
          if(betweenCoordinates(cellCoordinates, foundBurg) && elevation == itemElevationText){
              if(foundBurg.Burg == "Suliobriri"){console.log("Suliobriri is found")}
              break;
          } else {
            foundBurg = null;
          }
        }
        
        let cellAverageCoord = averageCellCoordinates(cellCoordinates);
        
        if(foundBurg){ //This cell contains a burg
          let foundburgName = foundBurg.Burg;
          //document.getElementById("outputData").value += "\nburgFound = " + foundburgName;
          jsonEntry.keys = "$Location["+foundburgName+"]";
          jsonEntry.entry = foundburgName + ":[ ";
          if(itemProvinceText){
            jsonEntry.entry += "DESC: a town in "+itemProvinceText+"; ";
          } else {
            jsonEntry.entry += "DESC: a town in the neutral zone; ";
          }
          jsonEntry.entry += "BIOME<"+foundburgName+">: " + itemBiomeText + "; ";
          jsonEntry.entry += "SUMMARY<"+foundburgName+">: ";
          if(foundBurg.Burg == "Suliobriri"){console.log("adding Suliobriri to jsonlist")}
        } else { //This cell does not contain a burg. It is wilderness
          jsonEntry.keys = "$Location["+itemBiomeText+"]";
          jsonEntry.entry = itemBiomeText + ":[ ";
          jsonEntry.entry += "DESC: "+ itemBiomeText + "; ";
          if(itemProvinceText){
            jsonEntry.entry += "SUMMARY: is inside "+itemProvinceText+", ";
          } else {
            jsonEntry.entry += "SUMMARY: ";
          }
        }
        //jsonEntry.entry += "it is "+stateVar["Area mi2"]+" square miles, "; //cell doesn't have an area in properties, maybe calculate?
        if(itemCultureText != "Wildlands"){
          jsonEntry.entry += "the dominant culture is "+itemCultureText+", ";
        }
        if(itemReligionText != "No religion"){
          jsonEntry.entry += "the common religion is "+itemReligionText+", ";
        }
        if(itemPopulationText > 0){
          jsonEntry.entry += itemPopulationText+" people live here";
        } else {
          jsonEntry.entry += "no people live here";
        }
        jsonEntry.entry += ".]"
        jsonEntryList.push(JSON.parse(JSON.stringify(jsonEntry)));
        
      }
      
      //Create lore entries for states. There should only be as much state lore as there are states
      let stateName;
      for (i = 0; i < statesDataArray.length; i++) { //Loops over the states to check it is selected in the checkboxes
        stateVar = statesDataArray[i];
        stateName = stateVar["State"];
        if(stateName){
          if(document.getElementById("statebox" + stateName).checked){
            cellFilteredStateData = burgDataArray.filter(burg => burg.State.indexOf(stateName) > -1);
            cellStateName = cellFilteredStateData[0].State; //Gets the actual name of the state
            jsonEntry.keys = "$Lore["+cellStateName+"]("+stateName+")";
            jsonEntry.entry = cellStateName + ":[ ";
            if(stateName == "Neutrals"){
              jsonEntry.entry += "DESC: neutral zone without king; ";
            } else {
              jsonEntry.entry += "DESC: "+stateVar["Form"]+"; ";
            }
            jsonEntry.entry += "SUMMARY<"+stateName+">: there are "+stateVar["Burgs"]+" towns, ";
            jsonEntry.entry += "the capital is "+stateVar["Capital"]+", ";
            jsonEntry.entry += "it is "+stateVar["Area mi2"]+" square miles, ";
            jsonEntry.entry += "the dominant culture is "+stateVar["Culture"]+", ";
            jsonEntry.entry += stateVar["Total Population"]+" people live here";
            jsonEntry.entry += ".]"
            jsonEntryList.push(JSON.parse(JSON.stringify(jsonEntry)));
          }
        }
      }
      
      //Create lore entries for provinces
      let provinceName, provinceVar, provinceStateName;
      for (i = 0; i < provinceDataArray.length; i++) {
        provinceVar = provinceDataArray[i];
        provinceStateName = provinceVar["State"];
        if(document.getElementById("statebox" + provinceStateName).checked){
          provinceName = provinceVar["Province"];
          if(provinceName){
            jsonEntry.keys = "$Lore["+provinceName+"]("+provinceName+")";
            jsonEntry.entry = provinceName + ":[ ";
            jsonEntry.entry += "DESC: a "+provinceVar["Form"]+" inside "+provinceVar["State"]+"; ";
            jsonEntry.entry += "SUMMARY: ";
            jsonEntry.entry += "the capital is "+provinceVar["Capital"]+", ";
            jsonEntry.entry += "it is "+provinceVar["Area mi2"]+" square miles, ";
            jsonEntry.entry += provinceVar["Total Population"]+" people live here";
            jsonEntry.entry += ".]"
            jsonEntryList.push(JSON.parse(JSON.stringify(jsonEntry)));
          }
        }
      }
      
      document.getElementById("outputJSONData").value = JSON.stringify(jsonEntryList);
      return;
    }
    
    
    
    //Takes an array of cell coordinates and a burg from a list
    //Returns true if the coordinates of the burg are inside the coordinates of the cell
    function betweenCoordinates(cellCoordinates, foundBurg) {
      let cellLongtitude, cellLatitude, burgLatitude, burgLongtitude
      let smallestCellLatitude, biggestCellLatitude, smallestCellLongtitude, biggestCellLongtitude;
      if(foundBurg.Burg == "Suliobriri"){console.log("calculating coords for Suliobriri")}
      burgLatitude = foundBurg.Latitude;
      burgLongtitude = foundBurg.Longitude;
      if(foundBurg.Burg == "Suliobriri"){console.log("burgLatitude = "+burgLatitude+", burgLongtitude = "+burgLongtitude)}
      for (x = 0; x < cellCoordinates.length; x++) {
        cellLongtitude = cellCoordinates[x][0];
        cellLatitude = cellCoordinates[x][1];
        if(x == 0){
          smallestCellLatitude = cellLatitude;
          smallestCellLongtitude = cellLongtitude;
          biggestCellLatitude = cellLatitude;
          biggestCellLongtitude = cellLongtitude;
        } else {
          if(cellLatitude < smallestCellLatitude){smallestCellLatitude = cellLatitude}
          if(cellLatitude > biggestCellLatitude){biggestCellLatitude = cellLatitude}
          if(cellLongtitude < smallestCellLongtitude){smallestCellLongtitude = cellLongtitude}
          if(cellLongtitude > biggestCellLongtitude){biggestCellLongtitude = cellLongtitude}
        }
      }
      if(foundBurg.Burg == "Suliobriri"){console.log("cellLatitude = "+cellLatitude+", cellLongtitude = "+cellLongtitude)}
      if(foundBurg.Burg == "Suliobriri"){console.log("biggestCellLongtitude = "+biggestCellLongtitude+", smallestCellLongtitude = "+smallestCellLongtitude)}
      if(foundBurg.Burg == "Suliobriri"){console.log("biggestCellLatitude = "+biggestCellLatitude+", smallestCellLatitude = "+smallestCellLatitude)}
      //document.getElementById("outputData").value += "\n cellLongtitude = "+cellLongtitude+", cellLatitude = "+cellLatitude+", burgLongtitude = "+burgLongtitude+", burgLatitude = "+burgLatitude;
      if(burgLongtitude > biggestCellLongtitude){
        return false;
      } else if (burgLongtitude < smallestCellLongtitude){
        return false;
      } else if (burgLatitude > biggestCellLatitude){
        return false;
      } else if (burgLatitude < smallestCellLatitude){
        return false;
      }
      if(foundBurg.Burg == "Suliobriri"){console.log("return true")}
        
      return true;
    }
    
    //Takes an array of pairs of coordinates.
    //Returns the average of the langtitude and the average of the latitude.
    function averageCellCoordinates(cellCoordinates) {
      let totalLatitude = 0;
      let totalLongtitude = 0;
      let avgLatitude = 0;
      let avgLongtitude = 0;
      let coordinatesLength = cellCoordinates.length;
      let cellLongtitude, cellLatitude;
      for (x = 0; x < coordinatesLength; x++) {
        cellLongtitude = cellCoordinates[x][0];
        cellLatitude = cellCoordinates[x][1];
        totalLatitude += cellLatitude;
        totalLongtitude += cellLongtitude;
      }
      avgLatitude = totalLatitude/coordinatesLength;
      avgLongtitude = totalLongtitude/coordinatesLength;
      //document.getElementById("outputData").value += "\n avgLatitude = " + avgLatitude + ", avgLongtitude = " + avgLongtitude;
      return [avgLongtitude, avgLatitude];
    }
    
    //Takes a data array of ID's and names, a number representing an id from that list and 
    //the name of a property that contains the name associated with that ID
    function numberToName(dataArray, number, property) {
      let name = "";
      let numberInt = parseInt(number);
      let selectedItems = dataArray.filter(item => item.Id == numberInt);
      if(selectedItems.length > 0){ //Since the dataArray should only include unique entries, the first of the filter result should be the correct entry
        name = selectedItems[0][property];
      }
      return name;
    }
    
    /*
  {
    "type": "worldDescription",
    "keys": "$Location[Apartment block](\"apartment\")",
    "entry": "Apartment block:[ DESC: Apartment; FEATURES<Apartment>: Blue window frames, fence around building, gap in center THRE: zombie.]",
    "hidden": false,
    "generator": "Manual",
    "name": null,
    "description": null,
    "attributes": {
      "name": null,
      "description": null
    }
  },
   */
</script>
</html>