<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Azgaar importer for AID</title>
  </head>
  <body>
    <p>Import Azgaar data to AID</p>
    
    <TABLE border=1>
      <TR>
        <TD colspan=2>Cell geojson data</TD><TD>Burgs csv data</TD><TD rowspan=10 id="statesCheckBoxes">Enter<BR>the<BR>data</TD>
      </TR>
      <TR>
        <TD colspan=2><textarea id="cellData" name="cellData" rows="4" cols="54"></textarea></TD>
        <TD><textarea id="burgData" name="burgData" rows="4" cols="50"></textarea></TD>
      </TR>
      <TR>
        <TD colspan=2>States csv data</TD><TD>Provinces csv data</TD>
      </TR>
      <TR>
        <TD colspan=2><textarea id="statesData" name="statesData" rows="4" cols="54"></textarea></TD>
        <TD><textarea id="provincesData" name="provincesData" rows="4" cols="50"></textarea></TD>
      </TR>
      <TR>
        <TD>Biome csv data</TD><TD>Culture csv data</TD><TD>Religion csv data</TD>
      </TR>
      <TR>
        <TD><textarea id="biomeData" name="biomeData" rows="4" cols="25"></textarea></TD>
        <TD><textarea id="cultureData" name="cultureData" rows="4" cols="25"></textarea></TD>
        <TD><textarea id="religionData" name="religionData" rows="4" cols="50"></textarea></TD>
      </TR>
      <TR>
        <TD colspan=2>Controls</TD><TD>Debug Output</TD>
      </TR>
      <TR>
        <TD colspan=2 rowspan=3>
          <button type="button" onclick="processdata()">Process data</button><BR>
          <button type="button" onclick="selectCells()">Convert cells</button>
        </TD>
        <TD><textarea id="outputData" name="outputData" rows="10" cols="50"></textarea></TD>
      </TR>
      <TR>
        <TD>JSON Output</TD>
      </TR>
      <TR>
        <TD><textarea id="outputJSONData" name="outputJSONData" rows="5" cols="50"></textarea></TD>
      </TR>
  </body>
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
  
  <script type="text/javascript">
    //The user has entered all the required data and pressed the 'process data' button.
    //It will create a list of checkboxes for the states
    function processdata() {
      let obj1 = JSON.parse(document.getElementById("cellData").value);
      let outputDataString = "";
      let islandTypes = obj1.features.filter(island => island.properties.type == 'island');
      outputDataString += "islandTypes.length = " + islandTypes.length + "\n";

      let csv = document.getElementById("statesData").value
      // Key data by field name instead of index/position
      var results = Papa.parse(csv, {
        header: true, skipEmptyLines: true
      });

      let statesDataArray = results.data
      outputDataString += "results.length = " + statesDataArray.length + "\n"; 
      let i, stateVar;
      let statesCheckHTML = "<div>"
      for (i = 0; i < statesDataArray.length; i++) {
        stateVar = statesDataArray[i]
        if(stateVar["State"]){
          statesCheckHTML += "<input type='checkbox' checked id='statebox" + stateVar["Id"] + "'/> " 
          statesCheckHTML += "<span style='display:none' id='state" + stateVar["Id"] + "'>" + stateVar["Id"] + "</span>";
          statesCheckHTML += "<label>" + stateVar["State"] + "</label><BR>"
        }
      } 
      statesCheckHTML += "</div>"
      
      let statesCheckBoxesElement = document.getElementById("statesCheckBoxes")
      statesCheckBoxesElement.innerHTML = statesCheckHTML;
      
      
      //let stateCells = [];
      //= islandTypes.filter(state => state.properties.state == 2);
      //outputDataString += "stateCells.length = " + stateCells.length + "\n";
      
      
      
      document.getElementById("outputData").value = outputDataString;
      
      
      
      //STActors = actors.filter(actor => actor.show == 'Stranger Things');
      //console.log(STActors);
      return "";
    }
    
    //Select all cells that have their state selected
    function selectCells() {

      let jsonData = document.getElementById("cellData").value
      let obj1 = JSON.parse(jsonData);
      let cellFeatures = obj1.features;
      let islandTypes = cellFeatures.filter(island => island.properties.type == 'island');
      let stateSelectedCells = [];
      let stateInt = 0;
      //let islandTypes = obj1.features.filter(island => island.properties.type == 'island');
      let csv;
      
      csv = document.getElementById("statesData").value
      if(csv == ""){
        alert("Missing states data. Please add it.");
        return;
      };
      // Key data by field name instead of index/position
      var statesDataJSON = Papa.parse(csv, {
        header: true, skipEmptyLines: true
      });
      let statesDataArray = statesDataJSON.data
      
      csv = document.getElementById("provincesData").value
      if(csv == ""){
        alert("Missing provinces data. Please add it.");
        return;
      };
      // Key data by field name instead of index/position
      var provincesDataJSON = Papa.parse(csv, {
        header: true, skipEmptyLines: true
      });
      let provincesDataArray = provincesDataJSON.data
      
      csv = document.getElementById("cultureData").value
      if(csv == ""){
        alert("Missing culture data. Please add it.");
        return;
      };
      // Key data by field name instead of index/position
      var cultureDataJSON = Papa.parse(csv, {
        header: true, skipEmptyLines: true
      });
      let cultureDataArray = cultureDataJSON.data
      
      csv = document.getElementById("religionData").value
      if(csv == ""){
        alert("Missing religion data. Please add it.");
        return;
      };
      // Key data by field name instead of index/position
      var religionDataJSON = Papa.parse(csv, {
        header: true, skipEmptyLines: true
      });
      let religionDataArray = religionDataJSON.data
      
      csv = document.getElementById("biomeData").value
      if(csv == ""){
        alert("Missing biome data. Please add it.");
        return;
      };
      // Key data by field name instead of index/position
      var biomeDataJSON = Papa.parse(csv, {
        header: true, skipEmptyLines: true
      });
      let biomeDataArray = biomeDataJSON.data
      
      csv = document.getElementById("burgData").value
      if(csv == ""){
        alert("Missing burg data. Please add it.");
        return;
      };
      // Key data by field name instead of index/position
      var burgDataJSON = Papa.parse(csv, {
        header: true, skipEmptyLines: true
      });
      let burgDataArray = burgDataJSON.data

      let i, stateVar;
      let stateCells = [];
      for (i = 0; i < statesDataArray.length; i++) {
        stateVar = statesDataArray[i]
        if(stateVar["Id"]){
          if(document.getElementById("statebox" + stateVar["Id"]).checked){
            stateInt = parseInt(stateVar["Id"]);
            stateSelectedCells = islandTypes.filter(state => state.properties.state == stateInt);
            stateCells = stateCells.concat(stateSelectedCells); 
          }
        }
      }
      
      document.getElementById("outputData").value += "\nstateCells.length = " + stateCells.length;
      
      let jsonCell = {}, jsonEntryList = [];
      jsonCell.type = "worldDescription"
      jsonCell.keys = ""
      jsonCell.entry = ""
      jsonCell.hidden = false;
      jsonCell.generator = "Manual"
      jsonCell.name = null
      jsonCell.description = null
      jsonCell.attributes = { "name": null, "description": null }
      
      let itemProvinceText, itemStateText, itemReligionText, itemCultureText, itemBiomeText, itemPopulationText;
      let burgLatitude, burgLongtitude, cellCoordinates, cellLatitude, cellLongtitude, burgFound, foundBurg;
      let filteredBurgData = [];
      var keys = [];
      
      let selectedCell, selectedProperties;
      for (i = 0; i < stateCells.length; i++) {
      //for (i = 0; i < 25; i++) {
        selectedCell = stateCells[i];
        selectedProperties = selectedCell.properties;
        cellCoordinates = selectedCell.geometry.coordinates[0];
        itemProvinceText = numberToName(provincesDataArray, selectedProperties.province, "Province");
        itemStateText = numberToName(statesDataArray, selectedProperties.state, "State");
        itemReligionText = numberToName(religionDataArray, selectedProperties.religion, "Religion");
        itemCultureText = numberToName(cultureDataArray, selectedProperties.culture, "Culture");
        itemBiomeText = numberToName(biomeDataArray, selectedProperties.biome, "Biome");
        itemPopulationText = selectedProperties.population;
        document.getElementById("outputData").value += "\n\nitemProvinceText("+selectedProperties.id+") = " + itemProvinceText;
        document.getElementById("outputData").value += "\nitemStateText = " + itemStateText;
        document.getElementById("outputData").value += "\nitemReligionText = " + itemReligionText;
        document.getElementById("outputData").value += "\nitemCultureText = " + itemCultureText;
        document.getElementById("outputData").value += "\nitemBiomeText = " + itemBiomeText;

        filteredBurgData = burgDataArray.filter(burg => burg.State.indexOf(itemStateText) > -1);
        document.getElementById("outputData").value += "\nfilteredBurgData("+i+").length = " + filteredBurgData.length;
        filteredBurgData = filteredBurgData.filter(burg => burg.Province.indexOf(itemProvinceText) > -1);
        document.getElementById("outputData").value += "\nfilteredBurgData("+i+").length = " + filteredBurgData.length;
        filteredBurgData = filteredBurgData.filter(burg => burg.Culture == itemCultureText);
        document.getElementById("outputData").value += "\nfilteredBurgData("+i+").length = " + filteredBurgData.length;
        filteredBurgData = filteredBurgData.filter(burg => burg.Religion == itemReligionText);
        document.getElementById("outputData").value += "\nfilteredBurgData("+i+").length = " + filteredBurgData.length;
        
        for (y = 0; y < filteredBurgData.length; y++) {
          foundBurg = filteredBurgData[y];
          if(betweenCoordinates(cellCoordinates, foundBurg)){
            document.getElementById("outputData").value += "\nburg "+foundBurg.Burg+" was it";
            break;
          } else {
            document.getElementById("outputData").value += "\nburg "+foundBurg.Burg+" not was it";
            foundBurg = null;
          }
        }
        
        let cellAverageCoord = averageCellCoordinates(cellCoordinates);
        
        if(foundBurg){ //This cell contains a burg
          let foundburgName = foundBurg.Burg;
          document.getElementById("outputData").value += "\nburgFound = " + foundburgName;
          jsonCell.keys = "$Location["+foundburgName+"]";
          jsonCell.entry = foundburgName + ":[ "
          jsonCell.entry += "DESC: town; "
          jsonCell.entry += "BIOME: " + itemBiomeText + "; ";
        } else { //This cell does not contain a burg. It is wilderness
          jsonCell.keys = "$Location["+itemBiomeText+"]";
          jsonCell.entry = itemBiomeText + ":[ "
          jsonCell.entry += "DESC: "+ itemBiomeText + "; ";
        }
        jsonCell.entry += "PROVINCE: " + itemProvinceText + "; ";
        jsonCell.entry += "STATE: " + itemStateText + "; ";
        jsonCell.entry += "RELIGION: " + itemReligionText + "; ";
        jsonCell.entry += "CULTURE: " + itemCultureText + "; ";
        jsonCell.entry += "LONGTITUDE: " + cellAverageCoord[0] + "; ";
        jsonCell.entry += "LATITUDE: " + cellAverageCoord[1] + "; ";
        jsonCell.entry += "POPULATION: " + itemPopulationText;
        jsonCell.entry += ".]"
        jsonEntryList.push(JSON.parse(JSON.stringify(jsonCell)));
        
        //i += 30;
      }
      
      document.getElementById("outputData").value += "\njsonCellList[2] = " + jsonEntryList[2].entry;
      document.getElementById("outputJSONData").value = JSON.stringify(jsonEntryList);
      return;
    }
    
    
    //Takes an array of cell coordinates and a burg from a list
    //Returns true if the coordinates of the burg are inside the coordinates of the cell
    function betweenCoordinates(cellCoordinates, foundBurg) {
      let cellLongtitude, cellLatitude, burgLatitude, burgLongtitude;
      burgLatitude = foundBurg.Latitude;
      burgLongtitude = foundBurg.Longitude;
      document.getElementById("outputData").value += "\nfoundburg = "+foundBurg.Burg+", lat = "+burgLatitude+", long = "+burgLongtitude
      for (x = 0; x < cellCoordinates.length; x++) {
        cellLongtitude = cellCoordinates[x][0];
        cellLatitude = cellCoordinates[x][1];
        document.getElementById("outputData").value += "\n cellLongtitude = "+cellLongtitude+", cellLatitude = "+cellLatitude+", burgLongtitude = "+burgLongtitude+", burgLatitude = "+burgLatitude;
        if(cellLongtitude > 0 && burgLongtitude > cellLongtitude){
          return false;
        } else if (cellLongtitude < 0 && burgLongtitude < cellLongtitude){
          return false;
        } else if (cellLatitude > 0 && burgLatitude > cellLatitude){
          return false;
        } else if (cellLatitude < 0 && burgLatitude < cellLatitude){
          return false;
        }
      }
      return true;
    }
    
    //Takes an array of pairs of coordinates.
    //Returns the average of the langtitude and the average of the latitude.
    function averageCellCoordinates(cellCoordinates) {
      let totalLatitude = 0;
      let totalLongtitude = 0;
      let avgLatitude = 0;
      let avgLongtitude = 0;
      let coordinatesLength = cellCoordinates.length;
      let cellLongtitude, cellLatitude;
      for (x = 0; x < coordinatesLength; x++) {
        cellLongtitude = cellCoordinates[x][0];
        cellLatitude = cellCoordinates[x][1];
        totalLatitude += cellLatitude;
        totalLongtitude += cellLongtitude;
      }
      avgLatitude = totalLatitude/coordinatesLength;
      avgLongtitude = totalLongtitude/coordinatesLength;
      document.getElementById("outputData").value += "\n avgLatitude = " + avgLatitude + ", avgLongtitude = " + avgLongtitude;
      return [avgLongtitude, avgLatitude];
    }
    
    //Takes a data array of ID's and names, a number representing an id from that list and 
    //the name of a property that contains the name associated with that ID
    function numberToName(dataArray, number, property) {
      let name = "";
      let numberInt = parseInt(number);
      let selectedItems = dataArray.filter(item => item.Id == numberInt);
      if(selectedItems.length > 0){ //Since the dataArray should only include unique entries, the first of the filter result should be the correct entry
        name = selectedItems[0][property];
      }
      return name;
    }
    
    /*
  {
    "type": "worldDescription",
    "keys": "$Location[Apartment block](\"apartment\")",
    "entry": "Apartment block:[ DESC: Apartment; FEATURES<Apartment>: Blue window frames, fence around building, gap in center THRE: zombie.]",
    "hidden": false,
    "generator": "Manual",
    "name": null,
    "description": null,
    "attributes": {
      "name": null,
      "description": null
    }
  },
   */
</script>
</html>